{"ast":null,"code":"import _asyncToGenerator from\"/Users/ted/Desktop/jbook/packages/local-client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/Users/ted/Desktop/jbook/packages/local-client/node_modules/@babel/runtime/regenerator/index.js\";import axios from'axios';import localforage from'localforage';var fileCache=localforage.createInstance({name:'filecache'});export var fetchPlugin=function fetchPlugin(inputCode){return{name:'fetch-plugin',setup:function setup(build){build.onLoad({filter:/(^index\\.js$)/},function(){return{loader:'jsx',contents:inputCode};});build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(args){var cachedResult;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context.sent;if(!cachedResult){_context.next=5;break;}return _context.abrupt(\"return\",cachedResult);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());build.onLoad({filter:/.css$/},/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(args){var _yield$axios$get,data,request,escaped,contents,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.get(args.path);case 2:_yield$axios$get=_context2.sent;data=_yield$axios$get.data;request=_yield$axios$get.request;escaped=data.replace(/\\n/g,'').replace(/\"/g,'\\\\\"').replace(/'/g,\"\\\\'\");// Trick for handling css files\ncontents=\"\\n                    const style = document.createElement('style');\\n                    style.innerText = '\".concat(escaped,\"';\\n                    document.head.appendChild(style);\\n                \");result={loader:'jsx',contents:contents,resolveDir:new URL('./',request.responseURL).pathname};// store response in cache\n_context2.next=10;return fileCache.setItem(args.path,result);case 10:return _context2.abrupt(\"return\",result);case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(args){var _yield$axios$get2,data,request,result;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return axios.get(args.path);case 2:_yield$axios$get2=_context3.sent;data=_yield$axios$get2.data;request=_yield$axios$get2.request;result={loader:'jsx',contents:data,resolveDir:new URL('./',request.responseURL).pathname};// store response in cache\n_context3.next=8;return fileCache.setItem(args.path,result);case 8:return _context3.abrupt(\"return\",result);case 9:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}());}};};","map":{"version":3,"sources":["/Users/ted/Desktop/jbook/packages/local-client/src/bundler/plugins/fetch-plugin.ts"],"names":["axios","localforage","fileCache","createInstance","name","fetchPlugin","inputCode","setup","build","onLoad","filter","loader","contents","args","getItem","path","cachedResult","get","data","request","escaped","replace","result","resolveDir","URL","responseURL","pathname","setItem"],"mappings":"2QACA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CACA,MAAOC,CAAAA,WAAP,KAAwB,aAAxB,CAEA,GAAMC,CAAAA,SAAS,CAAGD,WAAW,CAACE,cAAZ,CAA2B,CACzCC,IAAI,CAAE,WADmC,CAA3B,CAAlB,CAIA,MAAO,IAAMC,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAACC,SAAD,CAAuB,CAC9C,MAAO,CACHF,IAAI,CAAE,cADH,CAEHG,KAFG,gBAEGC,KAFH,CAE+B,CAC9BA,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,eAAV,CAAb,CAAyC,UAAM,CAC3C,MAAO,CACHC,MAAM,CAAE,KADL,CAEHC,QAAQ,CAAEN,SAFP,CAAP,CAIH,CALD,EAOAE,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,0FAA8B,iBAAOG,IAAP,yJAEEX,CAAAA,SAAS,CAACY,OAAV,CAAwCD,IAAI,CAACE,IAA7C,CAFF,QAEpBC,YAFoB,mBAIvBA,YAJuB,yDAKfA,YALe,wDAA9B,gEASAR,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,OAAV,CAAb,2FAAiC,kBAAOG,IAAP,uMACGb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CADH,wCACrBG,IADqB,kBACrBA,IADqB,CACfC,OADe,kBACfA,OADe,CAGvBC,OAHuB,CAGbF,IAAI,CACfG,OADW,CACH,KADG,CACI,EADJ,EAEXA,OAFW,CAEH,IAFG,CAEG,KAFH,EAGXA,OAHW,CAGH,IAHG,CAGG,KAHH,CAHa,CAQ7B;AACMT,QATuB,wHAWJQ,OAXI,gFAevBE,MAfuB,CAeQ,CACjCX,MAAM,CAAE,KADyB,CAEjCC,QAAQ,CAARA,QAFiC,CAGjCW,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHd,CAfR,CAoB7B;AApB6B,wBAqBvBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CArBuB,0CAuBtBA,MAvBsB,2DAAjC,kEA0BAd,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,2FAA+B,kBAAOG,IAAP,uLACKb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CADL,yCACnBG,IADmB,mBACnBA,IADmB,CACbC,OADa,mBACbA,OADa,CAGrBG,MAHqB,CAGU,CACjCX,MAAM,CAAE,KADyB,CAEjCC,QAAQ,CAAEM,IAFuB,CAGjCK,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAHd,CAHV,CAQ3B;AAR2B,uBASrBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CATqB,yCAWpBA,MAXoB,0DAA/B,kEAaH,CA1DE,CAAP,CA4DH,CA7DM","sourcesContent":["import * as esbuild from 'esbuild-wasm';\nimport axios from 'axios';\nimport localforage from 'localforage';\n\nconst fileCache = localforage.createInstance({\n    name: 'filecache'\n});\n\nexport const fetchPlugin = (inputCode: string) => {\n    return {\n        name: 'fetch-plugin',\n        setup(build: esbuild.PluginBuild) {\n            build.onLoad({ filter: /(^index\\.js$)/ },() => {\n                return {\n                    loader: 'jsx',\n                    contents: inputCode,\n                }\n            });\n\n            build.onLoad({ filter: /.*/ },async (args: any) => {\n                // Check to see if we have fetched this file\n                const cachedResult = await  fileCache.getItem<esbuild.OnLoadResult>(args.path);\n\n                if(cachedResult) {\n                    return cachedResult;\n                }\n            });\n\n            build.onLoad({ filter: /.css$/ },async (args: any) => {\n                const { data, request } = await axios.get(args.path);\n\n                const escaped = data\n                    .replace(/\\n/g, '')\n                    .replace(/\"/g, '\\\\\"')\n                    .replace(/'/g, \"\\\\'\");\n\n                // Trick for handling css files\n                const contents = `\n                    const style = document.createElement('style');\n                    style.innerText = '${escaped}';\n                    document.head.appendChild(style);\n                `;\n\n                const result: esbuild.OnLoadResult = {\n                    loader: 'jsx',\n                    contents,\n                    resolveDir: new URL('./', request.responseURL).pathname,\n                };\n                // store response in cache\n                await fileCache.setItem(args.path, result);\n\n                return result;\n            })\n\n            build.onLoad({ filter: /.*/ }, async (args: any) => {\n                const { data, request } = await axios.get(args.path);\n\n                const result: esbuild.OnLoadResult = {\n                    loader: 'jsx',\n                    contents: data,\n                    resolveDir: new URL('./', request.responseURL).pathname,\n                };\n                // store response in cache\n                await fileCache.setItem(args.path, result);\n\n                return result;\n            });\n        }\n    }\n}"]},"metadata":{},"sourceType":"module"}